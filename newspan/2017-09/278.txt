A week into his senior year, the 18-year-old student logged onto Amazon and bought a knife: a spring-loaded switchblade, slim enough to stay hidden in his pocket but sturdy enough, at a price of $30, that it could be lethal.
The student, Abel Cedeno, told a friend he felt trapped.  Under a Facebook video on Sept. 16 in which he popped the knife open, he asked why people thought he was soft. Detectives believe he started taking the knife to school, a five-story brick building on Mohegan Avenue in the Bronx where some parents worried their children were so unprotected that they had, in the past, taken to patrolling the hallways themselves.
That was the prelude to what on Wednesday became the first killing in a New York City public school classroom in two decades, a death that defied steep drops in crime and exposed how vulnerable city classrooms remain to unaddressed bullying and the violence that can follow.
During a history class, two classmates started pelting Mr. Cedeno from behind with pencil bits and balled-up paper, the police said. It was the first time the three of them had tangled, but two police officials stressed that it may not have seemed that way to Mr. Cedeno, who told detectives that other classmates had been harassing him since the start of school.
He got up and went to the bathroom, but when he returned, the tormenting continued, one of the police officials said. So he stood up, turned around and said something. A teacher, an aide and two dozen other students watched.
“What’d you call me?” one of the classmates, Matthew McCree, 15, answered. He strode up to Mr. Cedeno and punched him, according to one of the police officials.
Mr. Cedeno then pulled out his knife and, with two swings to Mr. McCree’s chest and one to his back, killed him, the police official said. Both police officials spoke on the condition of anonymity because the investigation was continuing. The other classmate, Ariane Laboy, who told detectives he did not yet realize his friend was being stabbed, stepped into the fracas, and Mr. Cedeno sliced him in the biceps, drawing so much blood that Mr. Laboy fainted.
Investigators are still building a picture of Mr. Cedeno’s life before the fatal confrontation: steady bullying by students he resisted naming in a police interview room; a mother who has been stranded in Puerto Rico by Hurricane Maria; enough difficulties in school that he was older than most of his classmates.
But the killing also seems to have taken place amid currents of homophobia, escalating fear and chaotic classrooms, which some parents and students said had been converging for weeks without the school gaining control.
Mr. Cedeno identified as bisexual to a small circle of people, a longtime family friend, Savannah Hornback, said. He also struggled with mental health issues, she said, though she declined to go into details.
She said he was a homebody who liked playing video games and keeping to himself. Neighbors described him as an “in-house kid” who held the door open for them, and said his mother went to Puerto Rico to visit family about a month ago. Ms. Hornback said being Hispanic and being bisexual made Mr. Cedeno a target of nasty slurs from classmates.
Ms. Hornback said Mr. Cedeno’s family was not trying to diminish what he did. But she said Mr. Cedeno’s mother had pleaded with staff members at the school for help protecting her son and had met with a guidance counselor there.
“There was no action from the school,” Ms. Hornback said.
At a news conference on Thursday morning, the chief of detectives for the New York Police Department, Robert K. Boyce, said Mr. Cedeno did not specifically cite his perceived sexual orientation as a reason he was being bullied or make clear why exactly he had bought the knife.
Chief Boyce told reporters that there was no indication Mr. Cedeno himself had complained to school officials about the abuse.
Matthew McCree, 15, was killed in the stabbing.
Toya Holness, a spokeswoman for the Department of Education, cited a federal student privacy law in declining to comment on whether the school was aware that Mr. Cedeno was being bullied, but she said the department was conducting an investigation.
A student who said he witnessed the stabbing, Frankie Santiago, 16, a junior who was friends with Mr. McCree, said, “The two teachers standing there did absolutely nothing.” He said Mr. McCree had not been bullying Mr. Cedeno and the encounter only grew violent when Mr. Cedeno challenged Mr. McCree to fight. He said Mr. Cedeno overreacted and appeared intent on hurting his two classmates.
At a court appearance on Thursday morning in which Mr. Cedeno was formally charged with murder, attempted murder and manslaughter, his lawyer, Deborah Rush, asked that her client be placed on suicide watch and receive a psychological evaluation. Mr. Cedeno signed an order of protection agreeing to avoid contact with Mr. Laboy, 16, who remained hospitalized. Mr. Cedeno was ordered jailed without bail.
A prosecutor, Nancy Borko, said at the hearing that Mr. Cedeno had confessed to the attack and to buying the knife.
City officials, facing an outcry from parents for not having had metal detectors at the school before, scrambled to put them in place on Thursday. But parents still kept their children home in droves: Less than a third of students at Mr. Cedeno’s school, the Urban Assembly School for Wildlife Conservation, and just under half of students at the elementary school that shares the building, Public School 67, attended school on Thursday.
Parents said their fears stemmed from a failure by school officials to deal with complaints of bullying. They described students cursing openly in hallways, taunting teachers and leaving condoms and marijuana blunts in the hallways.
Kayesha McIntosh, 32, said she once told school officials that students were pulling her daughter’s hair. They suggested she put her daughter’s hair in a bun.
Feeling abandoned by teachers, she said she visited the parents of one of the offending students herself.
Another mother, Jovana Russell, a former PTA president at P.S. 67, said she pulled her daughter from the elementary school after a high school student exposed himself to her in the stairwell several years ago. After parents’ requests for more security were turned down, she said, they started patrolling the hallways themselves.
Students described feeling as though they had to defend themselves. Some parents said that led to cycles of bullying and violence in which students who were bullied became angry at a lack of action by the school and started threatening other students.
There is little indication that the Wildlife Conservation school is one of the most dangerous in the city. But so routine was the trouble that another mother, Uneek Valentin, 37, said that she was having a meeting with the principal about bullying only to have the principal dash out of the office because a fight had broken out in the school.
Ms. Valentin’s son, Dwhy Hoyt, a senior, said bullies curse at teachers, skip class and slap books out of students’ hands, ruining the learning environment.
Mr. Hoyt, 17, said he had learned to defend himself, only to be chided by school officials for fighting, and had stopped reporting some incidents.
“I had to fight my own battles and make people into my friend,” he said.